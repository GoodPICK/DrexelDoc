=============
Interventions
=============


Autotext
--------

Страница для задания правил и редактирования текста сообщений которые будут генерироваться автоматически для *Intervention* с типом автотекст.

.. note:: Каждый текст будет отправлен как отдельное смс.
 
.. image:: /_static/Images/Figure_17.png
   :target: ../../latest/_images/Figure_17.png

*Figure_17 - Autotexts Inteface Page*

Описание Autotexts Inteface Page:
    1. выбор *Study*
    2. эллемент для вызова меню управления правилами данного автотекста
    3. текст отсылаемый в случае отправи данного сообщения
    4. редактирование текста сообщения данного автотекста
    5. общие правила отправки:
        * **Active** – делает данный текст активным или не активным, неактивные тексты неотсылаются даже при соблюдении всех остальных условий, активные - могут быть отосланы при соблюдении остальных условий
        * **Always Send** – добавляет текст к отправке даже если какие то другие условия не соблюдены (кроме Active, тоесть должны быть активны оба пункта чтобы сообщение было отправлено с 100% гарантией)
        * **Send if any goal failed** - добавляет текст к отправке если какое то из условий ниже невыполнено внезависимости от того используется оно или нет (что выбрано Done или Fail или DoNotUse)    
    6. группа настрое соответствующих целям study, для каждой настройки есть 3 варианта использования: 
        * **Done** – возвращает **true** если цель выполнена
        * **Fail** – возвращает **true** если цель провалена
        * **DoNotUse** – возвращает **true** в любом случае, тоесть игнорируется
    7. настройка указывающая пределы изменения веса в текущем периоде. Возвращает **true** если изменение веса прпадает в данные пределы. Если ничего не указывать то предел считается бесконечным.

.. note:: Для отправки сообщения каждого автотекста он должен быть отмечен как **Active** и все настройки из 6 и 7 группы должны возвращать состояние **true** или должен быть отмечен как **Active** и **Always Send**.

Для автотекста типа **Summary** окно настроек отличается
 
.. image:: /_static/Images/Figure_18.png
   :target: ../../latest/_images/Figure_18.png

*Figure_18 - Summary Autotext Interface*

Описание Summary Autotext Interface:
    1. Summary **Message Template**.
    2. переменные значения которых будет подставлено в **Message Template**
    3. общие правила отправки аналогичные подобным у других автотестов и описанные выше.
    
.. note:: В данный момент **Message Template** в автотексте применяются только для типа **Summary**, но могут быть добавлены и к другим автотестам

.. note:: **Message Template** – это значит что этот текст является заготовой для сообщения. **Message Template** имеет специальные метки (**{1}** - например) в которые будут подставлены подготовленные для него значения. Данные значения выбираются индивидуально для каждого пользователя. 


Intervention Feed
-----------------
Страница для просмотра *Intervention* для всех *Participant* состоящих в *Study Group* у которых координатором является выбранный *Clinician*. По умолчанию *Intervention* отсортированы по дате отправки по убыванию.

.. image:: /_static/Images/Figure_19.png
   :target: ../../latest/_images/Figure_19.png

*Figure_19 - Summary Autotext Interface*

Описание Summary Autotext Interface:
    1. Выбор *Clinician* для которого будут показаны *Intervention* связанных *Participant*
    2. Элемент для вызова окна ручного добавления *Intervention*
    3. Поле с именем *Participant* для которого создан *Intervention*, также является ссылкой на страницу Participant View (LINK!)
    4. Поле с ExternalId *Participant* для которого создан *Intervention*
    5. Date and Time of *Intervention*
    6. *Intervention* Type 
    7. Study в группе которого состоит *Participant*
    8. *Study Group* в которой состоит *Participant*
    9. Укороченный Текст Сообщения Отправленного в данном *Intervention*
    10. Елеемент добавляемый к укороченным сообщения для просмотра полного текста сообщения
    11. Поле указывающее был ли создан данный *Intervention* вручную 
    12. Елеемент добавляемый к созданым вручную *Intervention*, указыващий кем и когда был добавлен
    13. Статус *Intervention* 
    14. Ссылка на **Delivery Form** данного *Intervention*, для каждого типа своя страница
    15. Елеемент удаления *Intervention*

У *Intervention* может быть 3 статуса:
    1. **Delivered** - обработанные *Intervention*
    2. **Not Delivered** - необработанные *Intervention*
    3. **Prepared** - специальный статус для еще неотправленных Autotexts, после отправки он будет изменен в зависимости от результата на **Delivered** или **Not Delivered**

.. note:: На данной странице отображаются *Intervention* всех типов включая Notification и еще неотправленные Autotexts

.. note:: тип Autotexts не имеет страницы для обработки, поэтому Елеемент (пункт 14) помечен как недоступный

.. note:: При ручном создании *Intervention* типа автотекст, текст сообщения будет создан в момент отправки на основе автотекстов *Study Group* к которой привязан выбранный *Participant*


Delivery Forms
--------------
Delivery Forms - специальные страницы предназначенные для обработки *Intervention*. На этих страницах может быть изменен статут *Intervention* или записаны/просмотрены подробности интервеншена. Так же на данной странице для *Intervention* типа **Text Exchange** может производиться отправка Sms сообщений.

.. warning:: В текущий момент статут *Intervention* никак дополнительно не обрабатывается и служит только для удобства *Clinician*. 

Существует 4 основных типа интервеншенов:
    * **Call**
    * **Text Exchange**
    * **Visit**
    * **Autotext**

И дополнительный тип - **Notification**. **Notification** в целом не является *Intervention* и нигде не обрабатывается как *Intervention*. Он генерируется при оповещении пользователей о предстоящем *Intervention* 
и отображается в *Intervention Feed* только для того чтобы *Clinician* знали о том что данные сообщения были отосланы.

.. image:: /_static/Images/Figure_20.png
   :target: ../../latest/_images/Figure_20.png

*Figure_20 - Text Exchange Intervention Delivery Form*

Описание - Text Exchange Intervention Delivery Form:
    1. Заголовок содержит временной период за который будут показаны сообщения
    2. Окно для отображения сообщений. Синим цветом справа отображаются сообщения отправленные на номер пользователя.
    3. Элемент при использовании которого происходит отправа сообщения введенного в поле под пунктом 4
    4. Элемент для ввода текста сообщения которое будет отправлено в качестве смс.
    5. Выбор предыдущего временного периода, если таковой имеется
    6. Выбор следующего временного периода, если таковой имеется
    7. Данные пользователя связанного с *Intervention*
    8. Выбор статуса *Intervention*, под статусом подразумевается результат обработки интервеншена
    9. Поле ввода комментария. Комментарий служит лишь для описания каких либо дополнительных данных и не будет использоваться де либо на портале.
    10. Эллемент для сохранения изменений. Сохраняется только **Intervention State** и **Private Comments**, и никак не влияет на сообщения и данные *Participant*
    11. Удаление данного интервеншена
    12. Возврат на страницу *Intervention Feed*

.. note:: про автозаполнение первого месседжа

.. image:: /_static/Images/Figure_21.png
   :target: ../../latest/_images/Figure_21.png

*Figure_21 - Call Intervention Delivery Form*

Описание - Call Intervention Delivery Form:
    1. Данные пользователя связанного с *Intervention*
    2. Выбор статуса *Intervention*, под статусом подразумевается результат обработки интервеншена
    3. Для данного типа *Intervention*, предусмотрены дополнительные варианты статуса если выбран статут **Partial Visit**
    4. Подробности для дополнительного статуса **Other**, может быть заполнено любыми данными
    5. Поле для внесения каких либо подробностей *Intervention*
    6. Поле для внесения каких либо подробностей *Intervention*
    7. Удаление данного интервеншена
    8. Возврат на страницу *Intervention Feed*

.. note:: Visit Intervention Delivery Form аналогична Call Intervention Delivery Form. А подобной формы для *Intervention* типа **Autotext** не предусмотрено.

Interventions Setup
-------------------
Страница предназначена для создания и изменения правил по которым будут выбираться дни создания *Intervention*, и время создания *Intervention*.

.. image:: /_static/Images/Figure_22.png
   :target: ../../latest/_images/Figure_22.png

*Figure_22 - Call Intervention Delivery Form*

Описание Interventions Setup Page Interface:
    1. Выбор *Participant* для которого будут изменяться настройки
    2. Группа элементов для выбора дней недели в которые будут создаваться *Intervention*
    3. Дата начала создания *Intervention*, до этой даты *Intervention* создаваться не будут
    4. Дата окончания создания *Intervention*, после этой даты *Intervention* создаваться не будут
    5. Время создания *Intervention*, в это время будут отправляться *Intervention* типа autotext и создаваться *Intervention* для *Study Group* у которых не настроены *Clinician Schedule*
    6. Календарь для визуального отображения дней в которые будут отправлены *Intervention*, также служит елементом для ручной манипуляции днями в которые будут или не будут созданы интервеншены.

Используя календарь (пунтк 6) можно исключить день создания *Intervention*, для этого необходимо кликнуть по соответсвующему дню, если он окрашен зеленым. В случае успеха выбранный день календаря должен стать красным, что означает что в этот день портал не создаст для него *Intervention*

Также можно добавить день в который будет создан *Intervention* даже если настройки этого не предусматривают,для этого необходимо кликнуть по соответсвующему дню, если он окрашен белым. В случае успеха выбранный день календаря должен стать синим, что означает что в этот день портал принудительно создаст *Intervention*

.. note:: В отличии от ручного добавления *Intervention* использование данного способа позволит порталу самостоятельно выбрать тип интервеншена так как если бы этот день был указан в настройках

.. warning:: Interventions are created every day at 01:00 AM for Optimized groups and at 01:20 AM for Non-Optimized groups. Any changes to the schedule after these times won't have any effect for current day's schedule.


All Sms Messages
----------------
Данная страница служит для отображения всех сообщений полученных и отправленных *Participant*. Также имеется возможность отправки сообщений с этой страницы.

Страница очень похожа на страницу для обработки *Intervention* типа Text Exchange, но в отличие от нее содержит все сообщения. Для создания  Страницы было несколько причин. Во первых потому что раньше была возможность просмотра только тех сообщений которые попадали в определенный период связанный с *Intervention* типа Text Exchange, но данный период имел весьма искуственные ограничения, потому что мы не знаем когда точно ответят *Participant*, и какой либо ответ мог попасть не в тот период. Во вторых на практике выяснилось что *Participant* могут отвечать не только на *Intervention* типа Text Exchange и данные сообщения небыло возможности просмотреть.

.. warning:: Выбор *Participant* которому принадлежит сообщение выбирается на основе номера телефона указанного для этого *Participant*, поэтому при смене номера сообщения от другого номера телефона "теряются". на самом деле данные сообщения могут быть снова просмотрены при обратной смене номера.

