===========
Expressions
===========


Overview
--------
Expressions – необходимы для управления обработкой данных порталом без необходимости измененния самого портала. К соженению данная фича достаточно сложна для пониманию и требует некоторых навыков программирования,но это пожалуй единственный способ изменения обработки данных с полным контролем данных.

.. warning:: Нужно уделять особое внимание проверке при модифиации *expression*, потому что мы можем проверить только правильность синтаксиса при сохранении и не знаем что именно вернет измененный *Expression* при обработке реальных данных и к каким последсвиям это может привести.

.. warning:: Стоит помнить что каждый *Expression* предполагает множественное использование для различных заранее неизвестных наборов данных.

При создании Expression используются общие для всех Expression функции описанные в **Functions Description** и переменные подготовленные отдельно для каждого Expression.

**Functions Description** – справочная информация о всех доступных для использования функций с примерами их применения. Красные – фунции доступные из библиотеки ncalc (LINK!). Оранжевые – добавленные нами функции, в основном это фунции для работы с массивами.


Rs Espression
-------------
Выражение для расчета RS. Применяется при каждом расчете обновлении любых данных полученных от *Fitbit*.
 
 .. image:: /_static/Images/Figure_16.png
   :target: ../../_static/Images/Figure_16.png

*Figure_16 - Rs Expression Page Interface*

Описание Rs Expression Page Interface:
    1. поле ввода Expression, автоматически подсвечивает цветом переменные (синим), операторы (серым) и функции (красным или оранженым) при правильном вводе. Если введенная переменная или функция не подсветилась значит, скорее всего она введена неправильно
    2. эллемент для расчета RS. Данная страница содержит также все тестовые данные необходимые для расчета РС, поэтому при нажатии на calculate вы увидите тот RS который должен получиться при обработке этих ТЕСТОВЫХ данных. Данный эллемент необходим для того что бы можно было сразу проверить работоспособность Expression перед ее сохранением.
    3. сохранение expression для дальнейших расчетов с ее использованием на реальных данных пользователей
    4. результат расчета Expression для тестовых данных, после нажатия на calculate
    5. множетели для определенных типов данных, для реальных данных редактируются на странице Study / edit. 
    6. цели для определенных типов данных, для реальных данных редактируются на странице Study / edit либо на странице group view для индивидуальных целей. 
    7. дополнительные переменные, для реальных данных редактируются на странице Study / edit. 
    8. данные пользователя. Реальные данные получаются от фитбит.

.. note:: 5,6,7,8 - для тестирования они могут быть изменены на текущей странице. Кодовое название каждой переменной дано в квадратных собках синим цветом. Изменение значений переменных не приведет к изменению анологичных значений на портале, и дано исключительно для тестирования.


Optimazed Expression
--------------------
Также называется Group Optimazed Expression.

Данный *Expression* используется при генерации *Intervention* для групп с групповой оптимизацией. Каждый день в 12 часов ночи выбираются все пользователи группы для которых в этот день должен быть сгенерирован *Intervention*, для этих пользователей собираются дополнительные данные и формируются переменные для *Expression*. 

Для формирования списска *Intervention* которые будут сгенерированы для данный группы происходится перебор некоторых возможных состояний, для каждого из каторых вычисляется результат *Expression*. Состояние по сути является упорядоченным списком порядковых номеров типов *Intervention*. Перебирается множество состояний в поиске лучшего состояния. В идеальном случае для получения лучшего состояния должны быть перебраны все возможные комбинации *Intervention* для каждого *Participant*, но так как для большого количества *Participant* число комбинаций будет насколько велико что не может быть расчитано за разумное время, то мы применяет приблеженный метод поиска лучшего значения.

.. note:: Результатом *Expression* предпологается значение для состояния (state), которое станем наибольшим для наилучшего результата.

.. warning:: Обратите внимание что проверка на соответсвие ограничению по максимальному времени включено в *Expression* и соответсвенно может быть проигнорировано.

Например при генерации *Intervention* для 4ых человек лучшим состоянием стало - [1,0,0,2], что означает что для первого *Participant* будет выбран *Intervention* первого типа (из списка всех типов *Intervention* study в которой состоит *Participant*), для второго *Participant* будет выбран *Intervention* нулевого типа (нумерация начинается с нуля), для третьего *Participant* буде выбран *Intervention* нулевого типа, для четвертого *Participant* буде выбран *Intervention* второго типа. Затем на основе состояние будет сформирован список *Intervention*, если нулевой тип – автотекст (например), первый тип – текстлинициста, второй тип – звонок. в результате получится 2 автотекста, 1 звонок и 1 текстклинициста.

**добавить описание примеров**

Non-Optimazed Expression
------------------------
Также называется Individual Optimazed Expression.

Данный *Expression* применятся для генерации *Intervention* у групп с индивидуальной оптимизацией. Данное *Expression* обрабатывается индивидуально для каждого пользователя. Результатом выполнения должен быть id *Intervention* желаемого типа, один из **StudyInterventionIds**. Данные **StudyInterventionIds** соотвествую тем типам *Intervention* соответсвующие типам Study с которой связана выбранная *Study Group*.

Rs которые содержится в переменной **RScores** должен соответсвовать RS отображаемому на страницах study coordinator view and group view (LINK!). 

**Разобраться и описать примеры**
